<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational Video Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* NEW: Navigation Tabs */
        .navigation-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .nav-tab {
            background: transparent;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: #f0f7ff;
        }

        .nav-tab.active {
            background: #1976d2;
            color: white;
        }

        /* NEW: Project Browser Styles */
        .projects-browser {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .projects-header h2 {
            color: #1976d2;
            font-size: 1.8em;
        }

        .projects-actions {
            display: flex;
            gap: 15px;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .project-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            border-color: #1976d2;
        }

        .project-card.completed {
            border-left: 5px solid #4caf50;
        }

        .project-card.script-ready {
            border-left: 5px solid #ff9800;
        }

        .project-card.input-only {
            border-left: 5px solid #2196f3;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .project-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .project-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .project-status.completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .project-status.script-ready {
            background: #fff3e0;
            color: #ef6c00;
        }

        .project-status.input-only {
            background: #e3f2fd;
            color: #1976d2;
        }

        .project-status.empty {
            background: #fafafa;
            color: #757575;
        }

        .project-meta {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }

        .project-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .project-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .project-btn:hover {
            background: #1565c0;
            transform: translateY(-1px);
        }

        .project-btn.secondary {
            background: #4caf50;
        }

        .project-btn.secondary:hover {
            background: #45a049;
        }

        .project-btn.warning {
            background: #ff9800;
        }

        .project-btn.warning:hover {
            background: #f57c00;
        }

        .project-btn.danger {
            background: #f44336;
        }

        .project-btn.danger:hover {
            background: #d32f2f;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #1976d2;
        }

        /* Enhanced existing styles */
        .pipeline-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step {
            background: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #1976d2;
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: #4caf50;
            color: white;
        }

        .step-number {
            background: rgba(255,255,255,0.2);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section {
            display: none;
            padding: 30px;
        }

        .section.active {
            display: block;
        }

        /* Step 1: Content Input */
        .content-input {
            min-height: 400px;
        }

        .input-area {
            margin-bottom: 20px;
        }

        .input-area label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1976d2;
        }

        .content-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .content-textarea:focus {
            outline: none;
            border-color: #1976d2;
        }

        .file-upload {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #1976d2;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .file-upload:hover {
            background-color: #f5f5f5;
        }

        .file-upload input {
            display: none;
        }

        /* Step 2: Script Editor */
        .script-editor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .slides-panel {
            border-right: 2px solid #e0e0e0;
            padding-right: 20px;
        }

        .slide-item {
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .slide-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .slide-item.active {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .slide-header {
            background: #1976d2;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slide-content {
            padding: 15px;
        }

        .slide-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .slide-speaker {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .slide-text {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
        }

        .slide-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .preview-image {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
            min-height: 250px;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .edit-controls {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .edit-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: inherit;
            resize: vertical;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }

        /* Buttons */
        .btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #4caf50;
        }

        .btn-secondary:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #1976d2;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .status-message.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #2196f3;
        }

        .chat-window {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #1976d2;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: #e0e0e0;
            color: #333;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .chat-input button {
            padding: 8px 15px;
            border: none;
            background: #1976d2;
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }

        .video-result {
            text-align: center;
            padding: 40px;
        }

        .video-player {
            max-width: 800px;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .video-player video {
            width: 100%;
            height: auto;
        }

        .download-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 10px;
        }

        /* NEW: Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #1976d2;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .close-btn:hover {
            color: #f44336;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .script-editor {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .slides-panel {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                padding-right: 0;
                padding-bottom: 20px;
            }
            
            .pipeline-steps, .navigation-tabs {
                flex-direction: column;
                align-items: center;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }

            .projects-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workflow-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .workflow-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 250px;
        }

        .workflow-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .workflow-card.selected {
            border: 2px solid #1976d2;
            background: #e3f2fd;
        }

        .workflow-card h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .workflow-card p {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Educational Video Generator</h1>
            <p>Transform your educational content into engaging videos with AI-powered narration and visuals</p>
        </div>

        <!-- NEW: Navigation Tabs -->
        <div class="navigation-tabs">
            <button class="nav-tab active" onclick="showTab('projects')">
                📁 My Projects
            </button>
            <button class="nav-tab" onclick="showTab('create')">
                ➕ Create New
            </button>
        </div>

        <!-- NEW: Projects Browser Tab -->
        <div id="projectsTab" class="projects-browser">
            <div class="projects-header">
                <h2>📁 My Projects</h2>
                <div class="projects-actions">
                    <button class="btn" onclick="refreshProjects()">
                        🔄 Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="showTab('create')">
                        ➕ New Project
                    </button>
                </div>
            </div>
            
            <div id="projectsGrid" class="projects-grid">
                <!-- Projects will be loaded here -->
            </div>
            
            <div id="projectsLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading projects...</p>
            </div>
            
            <div id="projectsEmpty" class="empty-state" style="display: none;">
                <h3>📁 No Projects Found</h3>
                <p>You haven't created any projects yet. Click "Create New" to get started!</p>
                <button class="btn" onclick="showTab('create')" style="margin-top: 20px;">
                    ➕ Create Your First Project
                </button>
            </div>
        </div>

        <!-- Create New Project Tab -->
        <div id="createTab" class="main-content" style="display: none;">
            <!-- Workflow Selector -->
            <div class="workflow-selector">
                <div class="workflow-card selected" onclick="selectWorkflow('simple')">
                    <h3>🚀 Quick Generation</h3>
                    <p>One-click video creation<br>Content → Video</p>
                </div>
                <div class="workflow-card" onclick="selectWorkflow('advanced')">
                    <h3>⚙️ Advanced Workflow</h3>
                    <p>Step-by-step with editing<br>Content → Script → Edit → Video</p>
                </div>
            </div>

            <div class="pipeline-steps" id="pipelineSteps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <span>Input Content</span>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <span>Edit Script</span>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <span>Generate Video</span>
                </div>
            </div>

            <!-- Step 1: Content Input -->
            <div class="section active" id="step1">
                <h2 style="margin-bottom: 20px; color: #1976d2;">📝 Step 1: Input Your Educational Content</h2>
                
                <!-- Quick Actions for Simple Workflow -->
                <div class="quick-actions" id="quickActions">
                    <button class="quick-btn" onclick="generateCompleteVideo()">🎬 Generate Complete Video</button>
                    <button class="quick-btn" onclick="generateScriptOnly()">📝 Generate Script Only</button>
                </div>
                
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".md,.txt" onchange="handleFileUpload(event)">
                    <div>
                        <p style="font-size: 1.2em; margin-bottom: 10px;">📄 Upload Markdown File</p>
                        <p style="color: #666;">Click here to upload a .md file or drag and drop</p>
                    </div>
                </div>

                <div style="text-align: center; margin: 20px 0; color: #666; font-weight: 600;">OR</div>

                <div class="input-area">
                    <label for="contentInput">✏️ Enter your educational content in Markdown format:</label>
                    <textarea 
                        id="contentInput" 
                        class="content-textarea" 
                        placeholder="# Your Educational Content

## Activity 2.1: Understanding Chemical Reactions

* Collect the following solutions from the laboratory...
* Test each solution with indicators...

### Expected Observations:
- Acids turn blue litmus red
- Bases turn red litmus blue

**Learning Objectives:**
Students will understand the properties of acids and bases through hands-on experimentation."
                    ></textarea>
                </div>

                <div style="text-align: center;" id="advancedActions">
                    <button class="btn" onclick="generateScript()">
                        🚀 Generate Script & Visuals
                    </button>
                </div>

                <div class="progress-container" id="scriptProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="scriptProgressFill"></div>
                    </div>
                    <div class="progress-text" id="scriptProgressText">Generating script...</div>
                </div>

                <div class="status-message" id="scriptStatus"></div>
            </div>

            <!-- Step 2: Script Editor -->
            <div class="section" id="step2">
                <h2 style="margin-bottom: 20px; color: #1976d2;">✏️ Step 2: Review & Edit Script</h2>
                
                <div class="script-editor">
                    <div class="slides-panel">
                        <h3 style="margin-bottom: 15px;">📋 Lesson Steps</h3>
                        <div id="slidesList">
                            <!-- Slides will be populated here -->
                        </div>
                    </div>

                    <div class="preview-panel">
                        <h3 style="margin-bottom: 15px;">🖼️ Slide Preview</h3>
                        <div class="slide-preview" id="slidePreview">
                            <div class="preview-image" id="previewImage">
                                <p style="color: #666;">Select a slide to see its preview</p>
                            </div>
                        </div>

                        <div class="edit-controls" id="editControls" style="display: none;">
                            <h4 style="margin-bottom: 10px;">✏️ Edit Content</h4>
                            <textarea id="editTextarea" class="edit-textarea" placeholder="Edit the content for this slide..."></textarea>
                            <button class="btn btn-secondary" onclick="saveSlideEdit()">💾 Save Changes</button>
                            
                            <div class="chat-window" id="chatWindow" style="display: none;">
                                <div id="chatMessages"></div>
                                <div class="chat-input">
                                    <input type="text" id="chatInput" placeholder="Ask AI to modify the visual or content...">
                                    <button onclick="sendChatMessage()">Send</button>
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="toggleChat()" style="margin-top: 10px;">
                                🤖 Chat with AI
                            </button>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="goToStep(1)">← Back to Input</button>
                    <button class="btn btn-secondary" onclick="goToStep(3)" style="margin-left: 15px;">
                        🎬 Generate Video →
                    </button>
                </div>
            </div>

            <!-- Step 3: Video Generation -->
            <div class="section" id="step3">
                <h2 style="margin-bottom: 20px; color: #1976d2;">🎬 Step 3: Generate Your Video</h2>
                
                <div style="text-align: center; padding: 40px;">
                    <p style="font-size: 1.2em; margin-bottom: 30px; color: #666;">
                        Ready to create your educational video? This process will generate audio narration and combine it with your visuals.
                    </p>
                    
                    <button class="btn" id="generateVideoBtn" onclick="generateVideo()">
                        🎥 Generate Final Video
                    </button>
                </div>

                <div class="progress-container" id="videoProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="videoProgressFill"></div>
                    </div>
                    <div class="progress-text" id="videoProgressText">Generating video...</div>
                </div>

                <div class="status-message" id="videoStatus"></div>

                <div class="video-result" id="videoResult" style="display: none;">
                    <h3 style="color: #4caf50; margin-bottom: 20px;">🎉 Video Generated Successfully!</h3>
                    <div class="video-player">
                        <video id="generatedVideo" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    
                    <div class="download-section">
                        <h4 style="margin-bottom: 15px;">📥 Download Options</h4>
                        <button class="btn" onclick="downloadVideo()">
                            ⬇️ Download Video
                        </button>
                        <button class="btn btn-secondary" onclick="startNew()" style="margin-left: 15px;">
                            🆕 Create New Video
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Project Details Modal -->
        <div id="projectModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📁 Project Details</h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div id="modalContent">
                    <!-- Project details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- NEW: Delete Confirmation Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🗑️ Confirm Delete</h3>
                    <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
                </div>
                <div style="padding: 20px 0;">
                    <p>Are you sure you want to delete this project?</p>
                    <p style="color: #f44336; font-weight: 600; margin-top: 10px;">This action cannot be undone.</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn" style="background: #f44336; margin-left: 15px;" onclick="confirmDelete()">
                        🗑️ Delete Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let currentProject = null;
        let slides = [];
        let currentSlideIndex = 0;
        let workflowMode = 'simple';
        let currentTab = 'projects';
        let allProjects = [];
        let projectToDelete = null;

        // NEW: Global variables for visual functions and canvas
        let currentVisualFunctions = {};
        let previewCanvas = null;
        let previewCtx = null;

        // Initialize canvas for previews
        function initializePreviewCanvas() {
            if (!previewCanvas) {
                previewCanvas = document.createElement('canvas');
                previewCanvas.width = 1000;
                previewCanvas.height = 700;
                previewCtx = previewCanvas.getContext('2d');
            }
            return { canvas: previewCanvas, ctx: previewCtx };
        }

        // Helper function to reconstruct visual functions from server data
        function reconstructVisualFunctions(visualFunctionsData) {
            const reconstructedFunctions = {};
            
            if (!visualFunctionsData) {
                console.warn('⚠️ No visual functions data provided');
                return reconstructedFunctions;
            }
            
            Object.keys(visualFunctionsData).forEach(funcName => {
                try {
                    const funcData = visualFunctionsData[funcName];
                    
                    if (typeof funcData === 'function') {
                        // Already a function
                        reconstructedFunctions[funcName] = funcData;
                        console.log(`✅ Function ${funcName} already executable`);
                    } else if (typeof funcData === 'string') {
                        // Function as string - need to reconstruct
                        console.log(`🔧 Reconstructing function: ${funcName}`);
                        
                        // Extract function body from string
                        let funcBody = funcData;
                        
                        // Remove "function functionName(params) {" and trailing "}"
                        const funcMatch = funcBody.match(/function\s+\w+\s*\([^)]*\)\s*\{([\s\S]*)\}$/);
                        if (funcMatch) {
                            funcBody = funcMatch[1];
                        } else {
                            // Try arrow function format
                            const arrowMatch = funcBody.match(/\([^)]*\)\s*=>\s*\{([\s\S]*)\}$/);
                            if (arrowMatch) {
                                funcBody = arrowMatch[1];
                            }
                        }
                        
                        // Create new function with proper parameters
                        // Most visual functions expect (ctx, ...params)
                        reconstructedFunctions[funcName] = new Function('ctx', 'param1', 'param2', 'param3', funcBody);
                        console.log(`✅ Successfully reconstructed function: ${funcName}`);
                        
                    } else {
                        console.warn(`⚠️ Unexpected function type for ${funcName}:`, typeof funcData);
                    }
                } catch (error) {
                    console.error(`❌ Error reconstructing function ${funcName}:`, error);
                    
                    // Create a placeholder function that shows an error
                    reconstructedFunctions[funcName] = function(ctx) {
                        ctx.save();
                        ctx.fillStyle = '#ff6b6b';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Error loading ${funcName}`, 500, 400);
                        ctx.fillText('Check console for details', 500, 420);
                        ctx.restore();
                    };
                }
            });
            
            console.log(`🎨 Reconstructed ${Object.keys(reconstructedFunctions).length} visual functions`);
            return reconstructedFunctions;
        }

        // Helper functions for drawing preview components
        function drawPreviewBackground(ctx, speaker) {
            const SPEAKER_BACKGROUNDS = {
                teacher: '#f8fafe',
                student1: '#f3e8ff',
                student2: '#fefaf8'
            };
            
            const backgroundColor = SPEAKER_BACKGROUNDS[speaker] || '#e9f0f4';
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, 1000, 700);
        }

        function drawPreviewAvatars(ctx, activeSpeaker) {
            const LAYOUT = { AVATAR: { x: 30, y: 250, spacing: 70, size: 30 } };
            
            if (!currentProject || !currentProject.speakers) {
                console.warn('⚠️ No speakers data available for avatar rendering');
                return;
            }
            
            const speakerKeys = Object.keys(currentProject.speakers);
            
            speakerKeys.forEach((speaker, index) => {
                const config = currentProject.speakers[speaker];
                const isActive = speaker === activeSpeaker;
                const x = LAYOUT.AVATAR.x + LAYOUT.AVATAR.size / 2;
                const y = LAYOUT.AVATAR.y + (index * LAYOUT.AVATAR.spacing) + LAYOUT.AVATAR.size / 2;
                
                drawPreviewSingleAvatar(ctx, x, y, config, isActive);
            });
        }

        function drawPreviewSingleAvatar(ctx, x, y, config, isActive) {
            ctx.save();
            
            const radius = 15;
            
            if (isActive) {
                ctx.shadowColor = config.color;
                ctx.shadowBlur = 15;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
            
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = isActive ? '#fdbcb4' : lightenColor('#fdbcb4', 0.4);
            ctx.fill();
            
            ctx.lineWidth = isActive ? 3 : 1.5;
            ctx.strokeStyle = isActive ? config.color : lightenColor(config.color, 0.3);
            ctx.stroke();
            
            ctx.shadowBlur = 0;
            drawPreviewAvatarFace(ctx, x, y, radius * 0.8, isActive);
            
            ctx.fillStyle = isActive ? '#2c3e50' : lightenColor('#2c3e50', 0.4);
            ctx.font = `${isActive ? 'bold ' : ''}12px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(config.name, x, y + radius + 16);
            
            ctx.restore();
        }

        function drawPreviewAvatarFace(ctx, centerX, centerY, faceRadius, isActive) {
            ctx.save();
            
            const eyeColor = isActive ? '#2c3e50' : lightenColor('#2c3e50', 0.5);
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(centerX - faceRadius * 0.3, centerY - faceRadius * 0.2, faceRadius * 0.06, 0, Math.PI * 2);
            ctx.arc(centerX + faceRadius * 0.3, centerY - faceRadius * 0.2, faceRadius * 0.06, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = eyeColor;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(centerX, centerY + faceRadius * 0.1, faceRadius * 0.3, 0, Math.PI);
            ctx.stroke();
            
            ctx.restore();
        }

        function drawPreviewTextContent(ctx, step) {
            const LAYOUT = {
                TITLE: { x: 500, y: 75 },
                CONTENT: { x: 500, y: 120, width: 800 },
                CONTENT2: { x: 500, y: 145, width: 800 },
                MEDIA: { x: 200, y: 200, width: 600, height: 400 }
            };
            
            // Title
            ctx.fillStyle = '#1a5276';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(step.title, LAYOUT.TITLE.x, LAYOUT.TITLE.y);
            
            // Content
            ctx.fillStyle = '#2c3e50';
            if (step.content) {
                ctx.font = '22px Arial';
                wrapTextPreview(ctx, step.content, LAYOUT.CONTENT.x, LAYOUT.CONTENT.y, LAYOUT.CONTENT.width, 30);
            }
            if (step.content2) {
                ctx.font = '22px Arial';
                wrapTextPreview(ctx, step.content2, LAYOUT.CONTENT2.x, LAYOUT.CONTENT2.y + (step.content ? 30 : 0), LAYOUT.CONTENT2.width, 26);
            }
            
            // Draw media area border
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            ctx.strokeRect(LAYOUT.MEDIA.x, LAYOUT.MEDIA.y, LAYOUT.MEDIA.width, LAYOUT.MEDIA.height);
        }

        function wrapTextPreview(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;
            ctx.textAlign = 'center';

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, currentY);
        }

        function lightenColor(hex, factor) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            
            const newR = Math.min(255, Math.floor(r + (255 - r) * factor));
            const newG = Math.min(255, Math.floor(g + (255 - g) * factor));
            const newB = Math.min(255, Math.floor(b + (255 - b) * factor));
            
            return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
        }

        // FIXED: Enhanced updateSlidePreview function with actual visual rendering
        function updateSlidePreview(slide, index) {
            const previewImage = document.getElementById('previewImage');
            
            console.log(`🖼️ Updating preview for slide ${index + 1}:`, slide.title);
            console.log(`🎨 Visual info:`, slide.visual);
            console.log(`🔧 Available visual functions:`, Object.keys(currentVisualFunctions));
            
            // Initialize canvas
            const { canvas, ctx } = initializePreviewCanvas();
            
            try {
                // Clear canvas
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, 1000, 700);
                
                // Draw background for speaker
                drawPreviewBackground(ctx, slide.speaker);
                
                // Draw avatars
                drawPreviewAvatars(ctx, slide.speaker);
                
                // Draw text content
                drawPreviewTextContent(ctx, slide);
                
                // Draw visual function if present
                if (slide.visual && slide.visual.type && currentVisualFunctions[slide.visual.type]) {
                    console.log(`🎨 Executing visual function: ${slide.visual.type}`);
                    
                    try {
                        // Execute the visual function
                        if (slide.visual.params && slide.visual.params.length > 0) {
                            currentVisualFunctions[slide.visual.type](ctx, ...slide.visual.params);
                        } else {
                            currentVisualFunctions[slide.visual.type](ctx);
                        }
                        
                        console.log(`✅ Visual function executed successfully`);
                    } catch (error) {
                        console.error(`❌ Error executing visual function '${slide.visual.type}':`, error);
                        
                        // Draw error placeholder
                        ctx.save();
                        ctx.fillStyle = '#ff6b6b';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Error in ${slide.visual.type}()`, 500, 400);
                        ctx.fillText(error.message, 500, 420);
                        ctx.restore();
                    }
                } else if (slide.visual && slide.visual.type) {
                    console.warn(`⚠️ Visual function '${slide.visual.type}' not found`);
                    
                    // Draw missing function placeholder
                    ctx.save();
                    ctx.fillStyle = '#ff9800';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Missing visual: ${slide.visual.type}`, 500, 400);
                    ctx.restore();
                }
                
                // Convert canvas to image and display
                const imageDataUrl = canvas.toDataURL('image/png');
                previewImage.innerHTML = `<img src="${imageDataUrl}" alt="Slide ${index + 1} Preview" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                
            } catch (error) {
                console.error('❌ Error rendering preview:', error);
                previewImage.innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        <p>🖼️ Preview Error</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">${slide.title}</p>
                        <p style="font-size: 0.8em; color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // NEW: Tab Management
        function showTab(tabName) {
            currentTab = tabName;
            
            // Update navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'projects') {
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                document.getElementById('projectsTab').style.display = 'block';
                document.getElementById('createTab').style.display = 'none';
                loadProjects();
            } else if (tabName === 'create') {
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('createTab').style.display = 'block';
                selectWorkflow('simple');
            }
        }

        // NEW: Project Management Functions
        async function loadProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            const projectsLoading = document.getElementById('projectsLoading');
            const projectsEmpty = document.getElementById('projectsEmpty');
            
            // Show loading
            projectsLoading.style.display = 'block';
            projectsGrid.style.display = 'none';
            projectsEmpty.style.display = 'none';
            
            try {
                const response = await fetch('/api/projects');
                const result = await response.json();
                
                if (result.success) {
                    allProjects = result.projects;
                    displayProjects(allProjects);
                } else {
                    throw new Error(result.error || 'Failed to load projects');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                projectsLoading.style.display = 'none';
                projectsEmpty.style.display = 'block';
                projectsEmpty.innerHTML = `
                    <h3>❌ Error Loading Projects</h3>
                    <p>${error.message}</p>
                    <button class="btn" onclick="loadProjects()" style="margin-top: 20px;">
                        🔄 Retry
                    </button>
                `;
            }
        }

        function displayProjects(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            const projectsLoading = document.getElementById('projectsLoading');
            const projectsEmpty = document.getElementById('projectsEmpty');
            
            projectsLoading.style.display = 'none';
            
            if (projects.length === 0) {
                projectsGrid.style.display = 'none';
                projectsEmpty.style.display = 'block';
                return;
            }
            
            projectsEmpty.style.display = 'none';
            projectsGrid.style.display = 'grid';
            
            projectsGrid.innerHTML = projects.map(project => createProjectCard(project)).join('');
        }

        function createProjectCard(project) {
            const createdDate = new Date(project.createdAt).toLocaleDateString();
            const statusText = {
                'completed': 'Video Ready',
                'script_ready': 'Script Ready',
                'input_only': 'Input Only',
                'empty': 'Empty'
            }[project.status] || 'Unknown';
            
            const statusEmoji = {
                'completed': '✅',
                'script_ready': '📝',
                'input_only': '📄',
                'empty': '❓'
            }[project.status] || '❓';
            
            return `
                <div class="project-card ${project.status}" onclick="openProject('${project.projectId}')">
                    <div class="project-header">
                        <div>
                            <div class="project-title">${project.title}</div>
                            <div style="font-size: 0.8em; color: #999;">ID: ${project.projectId.substring(0, 8)}...</div>
                        </div>
                        <div class="project-status ${project.status}">
                            ${statusEmoji} ${statusText}
                        </div>
                    </div>
                    
                    <div class="project-meta">
                        <span>📅 ${createdDate}</span>
                        <span>📋 ${project.lessonStepsCount} steps</span>
                        ${project.hasVideo ? `<span>🎬 ${project.videoFiles.length} video(s)</span>` : ''}
                    </div>
                    
                    <div class="project-actions" onclick="event.stopPropagation();">
                        ${getProjectActions(project)}
                    </div>
                </div>
            `;
        }

        function getProjectActions(project) {
            let actions = [];
            
            if (project.status === 'completed') {
                actions.push(`<button class="project-btn secondary" onclick="playVideo('${project.projectId}')">▶️ Play</button>`);
                actions.push(`<button class="project-btn" onclick="downloadVideo('${project.projectId}')">⬇️ Download</button>`);
                actions.push(`<button class="project-btn warning" onclick="editProjectScript('${project.projectId}')">✏️ Edit Script</button>`);
            } else if (project.status === 'script_ready') {
                actions.push(`<button class="project-btn secondary" onclick="resumeProject('${project.projectId}')">▶️ Continue</button>`);
                actions.push(`<button class="project-btn warning" onclick="resumeProject('${project.projectId}')">✏️ Edit Script</button>`);
            } else if (project.status === 'input_only') {
                actions.push(`<button class="project-btn secondary" onclick="resumeProject('${project.projectId}')">▶️ Generate Script</button>`);
                actions.push(`<button class="project-btn warning" onclick="resumeProject('${project.projectId}')">✏️ Edit Input</button>`);
            }
            
            actions.push(`<button class="project-btn danger" onclick="deleteProject('${project.projectId}')">🗑️ Delete</button>`);
            
            return actions.join('');
        }

        // FIXED: Edit script for completed projects with visual function loading
        async function editProjectScript(projectId) {
            try {
                console.log(`🔧 Loading script for project: ${projectId}`);
                
                // First try the direct script endpoint
                console.log(`🔍 Trying direct script endpoint...`);
                const scriptResponse = await fetch(`/api/project/${projectId}/script`);
                const scriptResult = await scriptResponse.json();
                
                console.log('📊 Direct script result:', scriptResult);
                
                if (scriptResult.success && scriptResult.lessonStepsCount > 0) {
                    console.log(`✅ Direct script load successful: ${scriptResult.lessonStepsCount} steps`);
                    console.log(`🎨 Visual functions loaded:`, Object.keys(scriptResult.visualFunctions || {}));
                    
                    // CRITICAL: Store visual functions globally for preview rendering
                    currentVisualFunctions = reconstructVisualFunctions(scriptResult.visualFunctions);
                    
                    console.log(`🔧 Final currentVisualFunctions:`, Object.keys(currentVisualFunctions));
                    
                    // Set up the complete project data
                    currentProject = { 
                        projectId: projectId,
                        speakers: scriptResult.speakers || {},
                        visualFunctions: currentVisualFunctions, // Use processed functions
                        status: 'completed'
                    };
                    
                    slides = scriptResult.lessonSteps || [];
                    
                    console.log('📝 Setting slides array:', slides);
                    console.log('🔧 Current project setup complete');
                    
                    // Ensure we have speakers data
                    if (Object.keys(currentProject.speakers).length === 0) {
                        console.warn('⚠️ No speakers data found, loading default speakers');
                        currentProject.speakers = {
                            teacher: { voice: 'aditi', model: 'lightning-v2', name: 'Prof. Priya', color: '#1a5276', gender: 'female' },
                            student1: { voice: 'nikita', model: 'lightning-v2', name: 'Sneha', color: '#a9dfbf', gender: 'female' },
                            student2: { voice: 'lakshya', model: 'lightning-v2', name: 'Arjun', color: '#f39c12', gender: 'male' }
                        };
                    }
                    
                    // Switch to create tab and advanced workflow
                    showTab('create');
                    selectWorkflow('advanced');
                    
                    populateSlides();
                    goToStep(2);
                    showStatus('scriptStatus', '✅ Script loaded for editing! You can modify and regenerate the video.', 'success');
                    
                    // Initialize preview canvas
                    initializePreviewCanvas();
                    
                    return;
                }
                
                // Fallback to resume endpoint if direct script load fails
                console.log(`🔄 Falling back to resume endpoint...`);
                
                const response = await fetch(`/api/project/${projectId}/resume`);
                const result = await response.json();
                
                if (result.success) {
                    console.log('📊 Received project data from resume:', result.data);
                    
                    // Process visual functions from resume data
                    currentVisualFunctions = reconstructVisualFunctions(result.data.visualFunctions);
                    
                    // Set up the complete project data
                    currentProject = { 
                        projectId: projectId,
                        speakers: result.data.speakers || {},
                        visualFunctions: currentVisualFunctions,
                        projectDir: result.data.projectInfo?.projectPath || '',
                        status: result.data.projectInfo?.status || 'unknown'
                    };
                    
                    slides = result.data.lessonSteps || [];
                    
                    // Ensure we have speakers data
                    if (Object.keys(currentProject.speakers).length === 0) {
                        console.warn('⚠️ No speakers data found, loading default speakers');
                        currentProject.speakers = {
                            teacher: { voice: 'aditi', model: 'lightning-v2', name: 'Prof. Priya', color: '#1a5276', gender: 'female' },
                            student1: { voice: 'nikita', model: 'lightning-v2', name: 'Sneha', color: '#a9dfbf', gender: 'female' },
                            student2: { voice: 'lakshya', model: 'lightning-v2', name: 'Arjun', color: '#f39c12', gender: 'male' }
                        };
                    }
                    
                    if (slides.length === 0) {
                        console.error('❌ No slides loaded! Check script file structure.');
                        showStatus('scriptStatus', '⚠️ No slides found in project. The script file may be corrupted.', 'error');
                    } else {
                        console.log(`✅ Loaded ${slides.length} slides successfully`);
                    }
                    
                    // Switch to create tab and advanced workflow
                    showTab('create');
                    selectWorkflow('advanced');
                    
                    populateSlides();
                    goToStep(2);
                    showStatus('scriptStatus', '✅ Script loaded for editing! You can modify and regenerate the video.', 'success');
                    
                    // Initialize preview canvas
                    initializePreviewCanvas();
                    
                } else {
                    throw new Error(result.error || 'Failed to load project script');
                }
            } catch (error) {
                console.error('❌ Error loading project script:', error);
                alert('Error loading project script: ' + error.message);
            }
        }

        // NEW: Project Actions
        async function openProject(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}`);
                const result = await response.json();
                
                if (result.success) {
                    showProjectDetails(result.project);
                } else {
                    throw new Error(result.error || 'Failed to load project details');
                }
            } catch (error) {
                console.error('Error loading project details:', error);
                alert('Error loading project details: ' + error.message);
            }
        }

        function showProjectDetails(project) {
            const modal = document.getElementById('projectModal');
            const modalContent = document.getElementById('modalContent');
            
            const createdDate = new Date(project.createdAt).toLocaleString();
            const statusText = {
                'completed': 'Video Ready',
                'script_ready': 'Script Ready', 
                'input_only': 'Input Only',
                'empty': 'Empty'
            }[project.status] || 'Unknown';
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">${project.title}</h4>
                    <p><strong>Status:</strong> ${statusText}</p>
                    <p><strong>Created:</strong> ${createdDate}</p>
                    <p><strong>Lesson Steps:</strong> ${project.lessonStepsCount}</p>
                    <p><strong>Speakers:</strong> ${project.speakers.join(', ')}</p>
                    ${project.visualFunctions.length > 0 ? `<p><strong>Visual Functions:</strong> ${project.visualFunctions.join(', ')}</p>` : ''}
                    ${project.hasVideo ? `<p><strong>Videos:</strong> ${project.videoFiles.join(', ')}</p>` : ''}
                </div>
                
                <div style="text-align: center;">
                    ${project.status === 'completed' ? `
                        <button class="btn secondary" onclick="playVideo('${project.projectId}'); closeModal();">
                            ▶️ Play Video
                        </button>
                        <button class="btn" onclick="downloadVideo('${project.projectId}');">
                            ⬇️ Download
                        </button>
                        <button class="btn warning" onclick="editProjectScript('${project.projectId}'); closeModal();">
                            ✏️ Edit Script
                        </button>
                    ` : `
                        <button class="btn warning" onclick="resumeProject('${project.projectId}'); closeModal();">
                            ✏️ ${project.status === 'script_ready' ? 'Edit Script' : 'Continue Project'}
                        </button>
                    `}
                    
                    <button class="btn" style="background: #f44336; margin-left: 15px;" onclick="deleteProject('${project.projectId}'); closeModal();">
                        🗑️ Delete
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        async function resumeProject(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/resume`);
                const result = await response.json();
                
                if (result.success) {
                    // Set up the complete project data
                    currentProject = { 
                        projectId: projectId,
                        speakers: result.data.speakers || {},
                        visualFunctions: result.data.visualFunctions || {},
                        projectDir: result.data.projectInfo?.projectPath || '',
                        status: result.data.projectInfo?.status || 'unknown'
                    };
                    
                    // Switch to create tab and navigate to appropriate step
                    showTab('create');
                    
                    if (result.resumeStep === 2) {
                        // Resume at script editor
                        slides = result.data.lessonSteps || [];
                        selectWorkflow('advanced');
                        
                        // Ensure we have speakers data before populating slides
                        if (Object.keys(currentProject.speakers).length === 0) {
                            console.warn('No speakers data found, loading default speakers');
                            currentProject.speakers = {
                                teacher: { voice: 'aditi', model: 'lightning-v2', name: 'Prof. Priya', color: '#1a5276', gender: 'female' },
                                student1: { voice: 'nikita', model: 'lightning-v2', name: 'Sneha', color: '#a9dfbf', gender: 'female' },
                                student2: { voice: 'lakshya', model: 'lightning-v2', name: 'Arjun', color: '#f39c12', gender: 'male' }
                            };
                        }
                        
                        populateSlides();
                        goToStep(2);
                        showStatus('scriptStatus', '✅ Project resumed! Continue editing your script.', 'success');
                    } else if (result.resumeStep === 3) {
                        // Resume at video result
                        selectWorkflow('advanced');
                        goToStep(3);
                        
                        // Show the video if available
                        const videoResult = document.getElementById('videoResult');
                        const videoPlayer = document.getElementById('generatedVideo');
                        videoPlayer.src = `/api/video/${projectId}`;
                        videoResult.style.display = 'block';
                        
                        showStatus('videoStatus', '✅ Project resumed! Your video is ready.', 'success');
                    } else {
                        // Resume at input step
                        if (result.data.inputContent) {
                            document.getElementById('contentInput').value = result.data.inputContent;
                        }
                        selectWorkflow('advanced');
                        goToStep(1);
                        showStatus('scriptStatus', '✅ Project resumed! Continue from where you left off.', 'success');
                    }
                } else {
                    throw new Error(result.error || 'Failed to resume project');
                }
            } catch (error) {
                console.error('Error resuming project:', error);
                alert('Error resuming project: ' + error.message);
            }
        }

        function playVideo(projectId) {
            // Switch to create tab and show video
            showTab('create');
            selectWorkflow('advanced');
            goToStep(3);
            
            const videoResult = document.getElementById('videoResult');
            const videoPlayer = document.getElementById('generatedVideo');
            
            videoPlayer.src = `/api/video/${projectId}`;
            videoResult.style.display = 'block';
            
            // Set current project for download functionality
            currentProject = { projectId: projectId };
        }

        function downloadVideo(projectId) {
            window.open(`/api/download/${projectId}`, '_blank');
        }

        function deleteProject(projectId) {
            projectToDelete = projectId;
            document.getElementById('deleteModal').style.display = 'block';
        }

        async function confirmDelete() {
            if (!projectToDelete) return;
            
            try {
                const response = await fetch(`/api/project/${projectToDelete}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeDeleteModal();
                    refreshProjects();
                    showStatus('scriptStatus', '✅ Project deleted successfully.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to delete project');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project: ' + error.message);
            }
        }

        function refreshProjects() {
            loadProjects();
        }

        // Modal management
        function closeModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            projectToDelete = null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const projectModal = document.getElementById('projectModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target === projectModal) {
                closeModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        }

        // EXISTING FUNCTIONS (keeping all original functionality)

        // Workflow selection
        function selectWorkflow(mode) {
            workflowMode = mode;
            
            // Update UI based on workflow
            document.querySelectorAll('.workflow-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Find and select the correct workflow card
            const cards = document.querySelectorAll('.workflow-card');
            if (mode === 'simple' && cards[0]) {
                cards[0].classList.add('selected');
            } else if (mode === 'advanced' && cards[1]) {
                cards[1].classList.add('selected');
            }
            
            const quickActions = document.getElementById('quickActions');
            const advancedActions = document.getElementById('advancedActions');
            const pipelineSteps = document.getElementById('pipelineSteps');
            
            if (mode === 'simple') {
                quickActions.style.display = 'flex';
                advancedActions.style.display = 'none';
                pipelineSteps.style.display = 'none';
            } else {
                quickActions.style.display = 'none';
                advancedActions.style.display = 'block';
                pipelineSteps.style.display = 'flex';
            }
            
            console.log(`Switched to ${mode} workflow mode`);
        }

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('contentInput').value = e.target.result;
                };
                reader.readAsText(file);
            }
        }

        // Navigation functions
        function goToStep(step) {
            // Always allow navigation when we have a project
            if (workflowMode === 'simple' && !currentProject) {
                // Switch to advanced mode if we're navigating with a project
                selectWorkflow('advanced');
            }
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Hide all step indicators
            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
                if (parseInt(stepEl.dataset.step) < step) {
                    stepEl.classList.add('completed');
                } else {
                    stepEl.classList.remove('completed');
                }
            });
            
            // Show target section and activate step
            document.getElementById(`step${step}`).classList.add('active');
            const targetStepEl = document.querySelector(`[data-step="${step}"]`);
            if (targetStepEl) {
                targetStepEl.classList.add('active');
            }
            
            currentStep = step;
        }

        // Simple workflow: Complete video generation
        async function generateCompleteVideo() {
            const content = document.getElementById('contentInput').value.trim();
            if (!content) {
                showStatus('scriptStatus', 'Please enter some content first.', 'error');
                return;
            }

            showProgress('scriptProgress', 'Generating complete video (script + visuals + audio)... This may take 5-15 minutes.');
            
            try {
                const response = await fetch('/api/generate-video-complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content })
                });

                const result = await response.json();
                
                if (result.success) {
                    hideProgress('scriptProgress');
                    showStatus('scriptStatus', '🎉 Complete video generated successfully! Check your projects.', 'success');
                    
                    // Auto-refresh projects if we're on that tab
                    if (currentTab === 'projects') {
                        setTimeout(refreshProjects, 2000);
                    }
                } else {
                    throw new Error(result.error || 'Failed to generate video');
                }
            } catch (error) {
                hideProgress('scriptProgress');
                showStatus('scriptStatus', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Simple workflow: Script only generation
        async function generateScriptOnly() {
            const content = document.getElementById('contentInput').value.trim();
            if (!content) {
                showStatus('scriptStatus', 'Please enter some content first.', 'error');
                return;
            }

            showProgress('scriptProgress', 'Generating script and visuals...');
            
            try {
                const response = await fetch('/api/generate-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content })
                });

                const result = await response.json();
                
                if (result.success) {
                    hideProgress('scriptProgress');
                    showStatus('scriptStatus', '✅ Script generated successfully! Check your projects.', 'success');
                    
                    // Auto-refresh projects if we're on that tab
                    if (currentTab === 'projects') {
                        setTimeout(refreshProjects, 2000);
                    }
                } else {
                    throw new Error(result.error || 'Failed to generate script');
                }
            } catch (error) {
                hideProgress('scriptProgress');
                showStatus('scriptStatus', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Advanced workflow: Step 1 - Generate Script
        async function generateScript() {
            const content = document.getElementById('contentInput').value.trim();
            if (!content) {
                showStatus('scriptStatus', 'Please enter some content first.', 'error');
                return;
            }

            // Ensure we're in advanced mode
            if (workflowMode === 'simple') {
                selectWorkflow('advanced');
            }

            showProgress('scriptProgress', 'Generating script and visuals...');
            
            try {
                const response = await fetch('/api/generate-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentProject = result.data;
                    slides = result.data.lessonSteps;
                    
                    hideProgress('scriptProgress');
                    showStatus('scriptStatus', '✅ Script generated successfully! Moving to editor...', 'success');
                    
                    setTimeout(() => {
                        populateSlides();
                        generatePreviews();
                        goToStep(2);
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to generate script');
                }
            } catch (error) {
                hideProgress('scriptProgress');
                showStatus('scriptStatus', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Step 2: Populate slides in editor
        function populateSlides() {
            const slidesList = document.getElementById('slidesList');
            slidesList.innerHTML = '';
            
            if (!slides || slides.length === 0) {
                slidesList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No slides available</p>';
                return;
            }
            
            slides.forEach((slide, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = 'slide-item';
                slideEl.onclick = () => selectSlide(index);
                
                // Safe access to speaker name with fallback
                let speakerName = slide.speaker;
                if (currentProject && currentProject.speakers && currentProject.speakers[slide.speaker]) {
                    speakerName = currentProject.speakers[slide.speaker].name || slide.speaker;
                }
                
                slideEl.innerHTML = `
                    <div class="slide-header">
                        <span>Slide ${index + 1}</span>
                        <span>${slide.speaker}</span>
                    </div>
                    <div class="slide-content">
                        <div class="slide-title">${slide.title || 'Untitled Slide'}</div>
                        <div class="slide-speaker">Speaker: ${speakerName}</div>
                        <div class="slide-text">${(slide.content || '') + ' ' + (slide.content2 || '')}</div>
                    </div>
                `;
                
                slidesList.appendChild(slideEl);
            });
            
            if (slides.length > 0) {
                selectSlide(0);
            }
        }

        // Select a slide for editing
        function selectSlide(index) {
            // Update active slide
            document.querySelectorAll('.slide-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            currentSlideIndex = index;
            const slide = slides[index];
            
            // Update preview
            updateSlidePreview(slide, index);
            
            // Update edit controls
            const editControls = document.getElementById('editControls');
            const editTextarea = document.getElementById('editTextarea');
            
            editControls.style.display = 'block';
            editTextarea.value = JSON.stringify(slide, null, 2);
        }

        // Generate preview images
        async function generatePreviews() {
            if (!currentProject) return;
            
            try {
                const response = await fetch('/api/generate-previews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ projectId: currentProject.projectId })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentProject.previewImages = result.previewImages;
                    // Refresh current slide preview
                    if (slides[currentSlideIndex]) {
                        updateSlidePreview(slides[currentSlideIndex], currentSlideIndex);
                    }
                }
            } catch (error) {
                console.error('Failed to generate previews:', error);
            }
        }

        // Save slide edits
        function saveSlideEdit() {
            const editTextarea = document.getElementById('editTextarea');
            try {
                const updatedSlide = JSON.parse(editTextarea.value);
                slides[currentSlideIndex] = updatedSlide;
                
                // Update the slide display
                populateSlides();
                selectSlide(currentSlideIndex);
                
                showStatus('scriptStatus', '✅ Slide updated successfully!', 'success');
                setTimeout(() => hideStatus('scriptStatus'), 2000);
            } catch (error) {
                showStatus('scriptStatus', '❌ Invalid JSON format. Please check your edits.', 'error');
            }
        }

        // Chat functionality
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message) return;
            
            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);
            
            // Simulate AI response (you can implement actual LLM integration here)
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-message assistant';
                aiMsg.textContent = 'I understand you want to modify this slide. This feature will be available soon with full LLM integration for visual and content editing.';
                chatMessages.appendChild(aiMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
            
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Step 3: Generate Video
        async function generateVideo() {
            const generateBtn = document.getElementById('generateVideoBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '🔄 Generating...';
            
            showProgress('videoProgress', 'Generating video with optimized processing...');
            
            try {
                if (currentProject && currentProject.projectId) {
                    // Advanced workflow - use existing project
                    console.log('Using advanced workflow with project:', currentProject.projectId);
                    
                    const response = await fetch('/api/generate-video', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            projectId: currentProject.projectId,
                            slides: slides 
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        hideProgress('videoProgress');
                        showStatus('videoStatus', '🎉 Video generated successfully!', 'success');
                        
                        // Show video player
                        const videoResult = document.getElementById('videoResult');
                        const videoPlayer = document.getElementById('generatedVideo');
                        
                        videoPlayer.src = `/api/video/${currentProject.projectId}`;
                        videoResult.style.display = 'block';
                        
                        generateBtn.textContent = '✅ Video Generated';
                        
                        // Auto-refresh projects if we're on that tab
                        if (currentTab === 'projects') {
                            setTimeout(refreshProjects, 2000);
                        }
                    } else {
                        throw new Error(result.error || 'Failed to generate video');
                    }
                } else {
                    // Fallback to complete workflow if no project
                    console.log('No project found, using complete workflow');
                    
                    const content = document.getElementById('contentInput').value.trim();
                    if (!content) {
                        throw new Error('No content available for video generation');
                    }
                    
                    const response = await fetch('/api/generate-video-complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: content })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        hideProgress('videoProgress');
                        showStatus('videoStatus', '🎉 Video generated successfully! Check your projects.', 'success');
                        
                        // Show success message
                        const videoResult = document.getElementById('videoResult');
                        videoResult.style.display = 'block';
                        
                        // Hide video player since we don't have direct access to the file
                        const videoPlayer = document.getElementById('generatedVideo');
                        videoPlayer.style.display = 'none';
                        
                        generateBtn.textContent = '✅ Video Generated';
                        
                        // Auto-refresh projects if we're on that tab
                        if (currentTab === 'projects') {
                            setTimeout(refreshProjects, 2000);
                        }
                    } else {
                        throw new Error(result.error || 'Failed to generate video');
                    }
                }
                
            } catch (error) {
                hideProgress('videoProgress');
                showStatus('videoStatus', `❌ Error: ${error.message}`, 'error');
                generateBtn.disabled = false;
                generateBtn.textContent = '🎥 Generate Final Video';
            }
        }

        // Download video (overloaded to work with current project)
        function downloadVideo(projectId = null) {
            const id = projectId || (currentProject ? currentProject.projectId : null);
            if (id) {
                window.open(`/api/download/${id}`, '_blank');
            } else {
                alert('No project selected for download');
            }
        }

        // Start new project
        function startNew() {
            currentProject = null;
            slides = [];
            currentSlideIndex = 0;
            document.getElementById('contentInput').value = '';
            document.getElementById('videoResult').style.display = 'none';
            hideProgress('scriptProgress');
            hideProgress('videoProgress');
            hideStatus('scriptStatus');
            hideStatus('videoStatus');
            goToStep(1);
        }

        // Utility functions
        function showProgress(containerId, text) {
            const container = document.getElementById(containerId);
            const textEl = document.getElementById(containerId.replace('Progress', 'ProgressText'));
            container.style.display = 'block';
            textEl.textContent = text;
            
            // Simulate progress
            const fillEl = document.getElementById(containerId.replace('Progress', 'ProgressFill'));
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                fillEl.style.width = progress + '%';
            }, 500);
            
            container.dataset.interval = interval;
        }

        function hideProgress(containerId) {
            const container = document.getElementById(containerId);
            const fillEl = document.getElementById(containerId.replace('Progress', 'ProgressFill'));
            
            fillEl.style.width = '100%';
            setTimeout(() => {
                container.style.display = 'none';
                fillEl.style.width = '0%';
                
                // Clear interval
                if (container.dataset.interval) {
                    clearInterval(container.dataset.interval);
                }
            }, 500);
        }

        function showStatus(statusId, message, type) {
            const statusEl = document.getElementById(statusId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
        }

        function hideStatus(statusId) {
            const statusEl = document.getElementById(statusId);
            statusEl.style.display = 'none';
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fileUpload = document.querySelector('.file-upload');
            
            if (fileUpload) {
                fileUpload.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '#e3f2fd';
                });
                
                fileUpload.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '';
                });
                
                fileUpload.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                document.getElementById('contentInput').value = event.target.result;
                            };
                            reader.readAsText(file);
                        } else {
                            showStatus('scriptStatus', 'Please upload a .md or .txt file.', 'error');
                        }
                    }
                });
            }

            // Chat input enter key
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }

            // Initialize with projects tab
            showTab('projects');
            
            console.log('🚀 Enhanced Educational Video Generator Loaded!');
            console.log('✨ New Features: Project Management, Resume Functionality, Video Playback');
            console.log('🎨 NEW: Visual Preview System with Canvas Rendering!');
        });
    </script>
</body>
</html>